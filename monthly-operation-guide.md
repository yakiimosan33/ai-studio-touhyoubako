# 投票アプリ 月次運用マニュアル

## 概要
このアプリケーションは毎月異なるテーマで投票を実施するシステムです。以下の手順に従って月次運用を行ってください。

## 月次運用スケジュール

### 月末（25日頃）
1. **当月の投票締切確認**
   - 現在の投票期間が終了することを確認
   - 投票結果を確認・記録

2. **結果のバックアップ**
   - Notionデータベースから当月の投票データをエクスポート
   - CSVまたはPDF形式で保存

### 月初（1日〜5日）
以下の手順で新しい月の投票を設定します。

## 設定変更手順

### 1. テーマの更新
**ファイル:** `index.html` (行22-44)
```html
<!-- 各選択肢のテキストを変更 -->
<span class="option-text">新しいテーマ1</span>
<span class="option-text">新しいテーマ2</span>
<span class="option-text">新しいテーマ3</span>
<span class="option-text">新しいテーマ4</span>
```

**ファイル:** `script.js` (行6-11)
```javascript
const themes = {
    1: "新しいテーマ1",
    2: "新しいテーマ2",
    3: "新しいテーマ3",
    4: "新しいテーマ4"
};
```

**ファイル:** `api/vote.js` (行70-76)
```javascript
// 投票API - テーマ名を更新
case 1: return "新しいテーマ1";
case 2: return "新しいテーマ2";
case 3: return "新しいテーマ3";
case 4: return "新しいテーマ4";
```

**ファイル:** `api/results.js` (行36-41)
```javascript
// 結果表示API - テーマ名を更新
const themes = [
    "新しいテーマ1",
    "新しいテーマ2",
    "新しいテーマ3",
    "新しいテーマ4"
];
```

**ファイル:** `server.js` (行102-106) ※開発環境用
```javascript
// 開発環境のテーマ名も同様に更新
"新しいテーマ1": 0,
"新しいテーマ2": 0,
"新しいテーマ3": 0,
"新しいテーマ4": 0
```

### 2. タイトルと月の更新
**ファイル:** `index.html`
- 行6: `<title>AIクリエイターズ・スタジオ [新しい月]月テーマ投票</title>`
- 行11: `<h1>AIクリエイターズ・スタジオ [新しい月]月テーマ</h1>`

### 3. 投票締切日時の設定
**ファイル:** `index.html` (行16)
```html
<p class="deadline-text">投票締切: 2025年[月]月[日]日 23:50 (日本時間)</p>
```

**以下の全てのファイルで締切日時を統一して設定:**

**ファイル:** `api/vote.js` (行20)
```javascript
const deadline = new Date('2025-[MM]-[DD]T23:50:00+09:00');
```

**ファイル:** `api/deadline.js` (行18)
```javascript
const deadline = new Date('2025-[MM]-[DD]T23:50:00+09:00');
```

**ファイル:** `server.js` (行163) ※開発環境用
```javascript
const deadline = new Date('2025-[MM]-[DD]T23:50:00+09:00');
```

### 4. Notionデータベースの準備

#### 新規データベース作成（推奨）
1. Notionで新しいデータベースを作成
2. 以下のプロパティを設定：
   - 投票者ID (タイトル)
   - 投票テーマ (マルチセレクト)
   - 投票日時 (日付)
   - 投票数 (数値)

3. `.env`ファイルを更新
```env
NOTION_DATABASE_ID=新しいデータベースID
```

#### 既存データベースを使用する場合
1. Notionデータベースの「投票テーマ」プロパティに新しいテーマを追加
2. 過去のデータをアーカイブまたは別ビューで管理

### 5. 動作確認

1. **ローカルテスト**
```bash
npm start
```

2. **確認項目**
   - [ ] 新しいテーマが正しく表示される
   - [ ] 投票が正常に送信される
   - [ ] 締切日時が正しく表示される
   - [ ] カウントダウンが動作する
   - [ ] Notionにデータが保存される

3. **ブラウザのローカルストレージをクリア**
   - デベロッパーツール → Application → Local Storage
   - `voting_user_id`を削除してテスト投票

### 6. 本番環境への反映

1. **コードの更新**
   - Gitでコミット＆プッシュ
   - 本番サーバーにデプロイ

2. **環境変数の確認**
   - 本番環境の`.env`ファイルが正しく設定されているか確認

## 月中の運用

### 投票状況の確認
- Notionデータベースで投票数を随時確認
- 必要に応じて中間報告を作成

### トラブルシューティング

#### 投票が記録されない場合
1. `.env`ファイルの設定を確認
2. Notion APIトークンの有効性を確認
3. データベースIDが正しいか確認
4. サーバーログを確認

#### 締切が正しく動作しない場合
1. `server.js`の締切日時設定を確認
2. タイムゾーン設定（+09:00）を確認

## チェックリスト

### 月初設定時
- [ ] 前月の投票データをバックアップ
- [ ] 新しいテーマを4つ決定
- [ ] HTMLファイルのテーマを更新 (`index.html`)
- [ ] JavaScriptファイルのテーマを更新 (`script.js`)
- [ ] **【重要】** 投票APIのテーマを更新 (`api/vote.js`)
- [ ] **【重要】** 結果APIのテーマを更新 (`api/results.js`)
- [ ] 開発環境のテーマを更新 (`server.js`)
- [ ] タイトルと月を更新
- [ ] **【重要】** 全ファイルで締切日時を統一設定
  - [ ] `index.html` の表示テキスト
  - [ ] `api/vote.js` の締切判定
  - [ ] `api/deadline.js` の締切判定
  - [ ] `server.js` の締切判定（開発環境）
- [ ] Notionデータベースを準備
- [ ] **【重要】** データ整合性チェック
  - [ ] 全ファイルのテーマ名が完全一致するか確認
  - [ ] 締切日時が全ファイルで同じか確認
- [ ] ローカル環境でテスト
- [ ] 本番環境にデプロイ
- [ ] 本番環境で動作確認

### 月末確認時
- [ ] 投票締切を確認
- [ ] 最終結果を記録
- [ ] 参加者数と投票数を集計
- [ ] 必要に応じて結果レポートを作成

## 注意事項

1. **締切日時の設定**
   - 必ずJST（日本標準時）で設定
   - フォーマット: `YYYY-MM-DDTHH:mm:ss+09:00`

2. **テーマの一貫性**
   - **必須: 5箇所で完全に同じテーマ名を使用**
     - `index.html` （表示）
     - `script.js` （フロントエンド処理）
     - `api/vote.js` （投票保存）
     - `api/results.js` （結果表示）
     - `server.js` （開発環境）
   - **テーマ名が1文字でも異なると投票データと結果表示にずれが生じる**

3. **データベースの管理**
   - 毎月新規データベースを作成することを推奨
   - 過去のデータは別途アーカイブ

4. **セキュリティ**
   - `.env`ファイルは絶対にGitにコミットしない
   - Notion APIトークンは定期的に更新を検討

## 🚨 過去に発生した問題と対策

### 2025年9月: テーマ名の不一致問題
**問題:** 投票時は新しいテーマで投票されるが、結果表示時に過去のテーマ名が表示される

**原因:** 
- `api/vote.js` は修正済みだったが、`api/results.js` が古いテーマ名を参照
- フロントエンドとAPIのマッピングが不一致

**対策:**
- **必ず5つのファイル全てでテーマ名を統一する**
- 更新後は必ず整合性チェックを実施
- 運用マニュアルのチェックリストに追加

**再発防止:**
```bash
# テーマ名の一貫性チェックコマンド例
grep -r "テーマ1" *.html *.js api/*.js
```

### データ整合性チェックの方法

**手動チェック:**
1. 各ファイルのテーマ名を目視確認
2. 締切日時設定を全ファイルで確認
3. テスト投票で実際の動作を確認

**推奨ツール:**
- Git diff でコミット前の変更内容を確認
- 本番反映前に必ずローカルテストを実施